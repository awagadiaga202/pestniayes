{% extends 'gestion/base.html' %}
{% load widget_tweaks %}

{% block title %}Nouvelle Vente{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

<div class="container mt-4">
    <h3 class="text-center mb-4">Nouvelle Vente</h3>
    <form method="post">
        {% csrf_token %}

        <!-- Informations g√©n√©rales -->
        <div class="card mb-4 p-3">
            <h5>Informations G√©n√©rales</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label>Client</label>
                    {{ vente_form.client|add_class:"form-select" }}
                </div>
                <div class="col-md-6 mb-3">
                    <label>Vendeur</label>
                    {{ vente_form.vendeur|add_class:"form-select" }}
                </div>
                <div class="col-md-6 mb-3">
                    <label>Date de vente</label>
                    {{ vente_form.date_vente|add_class:"form-select" }}
                </div>

                <div class="col-md-6 mb-3">
                    <label>Type de vente</label>
                    {{ vente_form.type_vente|add_class:"form-control" }}
                </div>

                <div class="col-md-6 mb-3">
                    <label>Mode de paiement</label>
                    {{ vente_form.mode_paiement|add_class:"form-select" }}
                </div>
                <div class="col-12 mb-3">
                    <label>Commentaire</label>
                    {{ vente_form.commentaire|add_class:"form-control" }}
                </div>
            </div>
        </div>

        <!-- Produits achet√©s -->
        <div class="card p-3 mb-4">
            <h5>Produits achet√©s</h5>
            {{ formset.management_form }}
            <table class="table table-bordered align-middle" id="ligne-produits-table">
                <thead>
                    <tr>
                        <th>Produit</th>
                         <th>D√©p√¥t</th>

                        <th>Quantit√©</th>

                        <th>Remise</th>
                        <th>Montant ligne (F)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="formset">
                    {% for form in formset %}
                    <tr class="ligne-formset">
                        <td>{{ form.produit|add_class:"form-control" }}</td>
                        <td>{{ form.prix_unitaire|add_class:"form-control prix-unitaire" }}</td>
                        <td>{{ form.quantite|add_class:"form-control quantite" }}</td>
                        <td>{{ form.remise|add_class:"form-control remise" }}</td>
                        <td>
                            <span class="montant-ligne">0.00</span> F
                            <!-- Champ cach√© qui va contenir le montant r√©el -->
                            {{ form.montant|add_class:"form-control d-none montant-input" }}
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm supprimer-ligne">X</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
            <button type="button" class="btn btn-outline-primary" id="add-ligne">‚ûï Ajouter un produit</button>
        </div>

        <!-- Total g√©n√©ral -->
        <div class="mb-3 text-end">
            <strong>Total g√©n√©ral : <span id="montant-total-global">0.00</span> F</strong>
        </div>

        <button type="submit" class="btn btn-success w-100">üíæ Enregistrer la vente</button>
        {% if vente_form.errors %}
    <div class="alert alert-danger">
        {{ vente_form.errors }}
    </div>
{% endif %}

{% for form in formset %}
    {% if form.errors %}
        <div class="alert alert-danger">
            {{ form.errors }}
        </div>
    {% endif %}
{% endfor %}

    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const formsetTable = document.getElementById("formset");

    function recalculerMontants() {
        let totalGeneral = 0;

        formsetTable.querySelectorAll(".ligne-formset").forEach(ligne => {
            const prix = parseFloat(ligne.querySelector(".prix-unitaire").value) || 0;
            const quantite = parseInt(ligne.querySelector(".quantite").value) || 0;
            const remise = parseFloat(ligne.querySelector(".remise").value) || 0;

            let total = (prix * quantite) - remise;
            if (total < 0) total = 0;

            // Affichage utilisateur
            ligne.querySelector(".montant-ligne").textContent = total.toFixed(2);

            // Mise √† jour du champ cach√© (input montant)
            const montantInput = ligne.querySelector(".montant-input");
            if (montantInput) {
                montantInput.value = total.toFixed(2);
            }

            totalGeneral += total;
        });

        // Afficher le total g√©n√©ral
        document.getElementById("total-general").textContent = totalGeneral.toFixed(2);
    }

    // √âv√©nements pour recalculer √† chaque saisie
    formsetTable.addEventListener("input", function (event) {
        if (event.target.classList.contains("prix-unitaire") ||
            event.target.classList.contains("quantite") ||
            event.target.classList.contains("remise")) {
            recalculerMontants();
        }
    });

    // Recalcul initial
    recalculerMontants();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        $('#id_client').select2({ width: '100%' });
    });
</script>
{% if form_commande.errors %}
    <div class="alert alert-danger">
        {{ form_commande.errors }}
    </div>
{% endif %}

{% if formset_lignes.errors %}
    <div class="alert alert-danger">
        {{ formset_lignes.errors }}
    </div>
{% endif %}
{% endblock %}
