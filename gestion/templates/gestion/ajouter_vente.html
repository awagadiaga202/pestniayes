{% extends 'gestion/base.html' %}
{% load widget_tweaks %}

{% block title %}Nouvelle Vente{% endblock %}

{% block content %}
<!-- CSS Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- jQuery et Select2 -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container mt-4">
    <h3 class="text-center mb-4">Nouvelle Vente</h3>

    <form method="post">
        {% csrf_token %}

        <!-- Informations g√©n√©rales -->
        <div class="card mb-4 p-3">
            <h5>Informations G√©n√©rales</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label>Client</label>
                    {{ vente_form.client|add_class:"form-select" }}
                </div>
                <div class="col-md-6 mb-3">
                    <label>Vendeur</label>
                    {{ vente_form.vendeur|add_class:"form-select" }}
                </div>
                <div class="col-md-6 mb-3">
                    <label>Date de vente</label>
                    {{ vente_form.date_vente|add_class:"form-select" }}
                </div>
                <div class="col-md-6 mb-3">
                    <label>Type de vente</label>
                    {{ vente_form.type_vente|add_class:"form-control" }}
                </div>
                <div class="col-md-6 mb-3">
                    <label>Mode de paiement</label>
                    {{ vente_form.mode_paiement|add_class:"form-select" }}
                </div>
                <div class="col-12 mb-3">
                    <label>Commentaire</label>
                    {{ vente_form.commentaire|add_class:"form-control" }}
                </div>
            </div>
        </div>

        <!-- Produits achet√©s -->
        <div class="card p-3 mb-4">
            <h5>Produits achet√©s</h5>
            {{ formset.management_form }}
            <table class="table table-bordered align-middle" id="ligne-produits-table">
                <thead>
                    <tr>
                        <th>Produit</th>
                        <th>D√©p√¥t</th>
                        <th>Quantit√©</th>
                        <th>Remise</th>
                        <th>Montant ligne (F)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="formset-body">
                    {% for form in formset %}
                        <tr class="ligne-form">
                            <td>{{ form.produit|add_class:"form-select produit-select" }}</td>
                            <td>{{ form.depot|add_class:"form-select" }}</td>
                            <td>{{ form.quantite|add_class:"form-control quantite-input" }}</td>
                            <td>{{ form.remise|add_class:"form-control remise-input" }}</td>
                            <td><span class="montant-ligne">0.00</span> F</td>
                            <td><button type="button" class="btn btn-danger btn-sm remove-row">üóëÔ∏è</button></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="button" class="btn btn-outline-primary" id="add-ligne">‚ûï Ajouter un produit</button>
        </div>

        <!-- Total g√©n√©ral -->
        <div class="mb-3 text-end">
            <strong>Total g√©n√©ral : <span id="montant-total-global">0.00</span> F</strong>
        </div>

        <button type="submit" class="btn btn-success w-100">üíæ Enregistrer la vente</button>

        {% if vente_form.errors %}
        <div class="alert alert-danger">{{ vente_form.errors }}</div>
        {% endif %}

        {% for form in formset %}
            {% if form.errors %}
                <div class="alert alert-danger">{{ form.errors }}</div>
            {% endif %}
        {% endfor %}

    </form>
</div>

<script>
$(document).ready(function() {
    // Initialiser Select2
    $('#id_client').select2({ width: '100%' });

    const produitsPrix = {
        {% for produit in produits %}
            '{{ produit.id }}': {{ produit.prix_unitaire|floatformat:2 }},
        {% endfor %}
    };

    function recalculerMontants() {
        let totalGlobal = 0;
        $('.ligne-form').each(function() {
            const produitId = $(this).find('.produit-select').val();
            const quantite = parseFloat($(this).find('.quantite-input').val()) || 0;
            const remise = parseFloat($(this).find('.remise-input').val()) || 0;
            const prix = produitsPrix[produitId] || 0;
            let total = (prix * quantite) - remise;
            if (total < 0) total = 0;
            $(this).find('.montant-ligne').text(total.toFixed(2));
            totalGlobal += total;
        });
        $('#montant-total-global').text(totalGlobal.toFixed(2));
    }

    $(document).on('input change', '.ligne-form input, .ligne-form select', recalculerMontants);

    $('#add-ligne').click(function() {
        const formCountInput = $('#id_form-TOTAL_FORMS');
        const formCount = parseInt(formCountInput.val());
        const lastRow = $('#formset-body .ligne-form:last').clone();

        lastRow.find('input, select').each(function() {
            const name = $(this).attr('name').replace(/\d+/, formCount);
            const id = $(this).attr('id').replace(/\d+/, formCount);
            $(this).attr({name: name, id: id}).val('');
            if ($(this).is('select')) $(this).prop('selectedIndex', 0);
        });

        lastRow.find('.montant-ligne').text('0.00');
        $('#formset-body').append(lastRow);
        formCountInput.val(formCount + 1);
        recalculerMontants();
    });

    $(document).on('click', '.remove-row', function() {
        if ($('.ligne-form').length > 1) {
            $(this).closest('tr').remove();
            $('#id_form-TOTAL_FORMS').val($('.ligne-form').length);
            recalculerMontants();
        }
    });

    recalculerMontants(); // Initialisation
});
</script>
{% endblock %}
