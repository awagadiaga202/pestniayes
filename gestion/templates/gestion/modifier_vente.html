{% extends 'gestion/base.html' %}
{% load widget_tweaks %}

{% block title %}Nouvelle Vente{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

<div class="container mt-4">
    <h3 class="text-center mb-4">Modifier la vente </h3>
    <form method="post">
        {% csrf_token %}

        <!-- Informations g√©n√©rales -->
        <div class="card mb-4 p-3">
            <h5>Informations G√©n√©rales</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label>Client</label>
                    {{ vente_form.client|add_class:"form-select" }}
                </div>
                <div class="col-md-6 mb-3">
                    <label>Vendeur</label>
                    {{ vente_form.vendeur|add_class:"form-select" }}
                </div>
                <div class="col-md-6 mb-3">
                    <label>Date de vente</label>
                    {{ vente_form.date_vente|add_class:"form-select" }}
                </div>
                <div class="col-md-6 mb-3">
                    <label>Type de vente</label>
                    {{ vente_form.type_vente|add_class:"form-control" }}
                </div>

                <div class="col-md-6 mb-3">
                    <label>Mode de paiement</label>
                    {{ vente_form.mode_paiement|add_class:"form-select" }}
                </div>
                <div class="col-12 mb-3">
                    <label>Commentaire</label>
                    {{ vente_form.commentaire|add_class:"form-control" }}
                </div>
            </div>
        </div>

        <!-- Produits achet√©s -->
        <div class="card p-3 mb-4">
            <h5>Produits achet√©s</h5>
            {{ formset.management_form }}
            <table class="table table-bordered align-middle" id="ligne-produits-table">
                <thead>
                    <tr>
                        <th>Produit</th>
                         <th>D√©p√¥t</th>

                        <th>Quantit√©</th>

                        <th>Remise</th>
                        <th>Montant ligne (F)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="formset-body">
                    {% for form in formset %}
                        <tr class="ligne-form">
                            <td style="display:none;">
                                {{ form.id }}
                            </td>

                            <td>{{ form.produit|add_class:"form-select produit-select" }}</td>
                            <td>{{ form.depot|add_class:"form-select" }}</td>

                            <td>{{ form.quantite|add_class:"form-control quantite-input" }}</td>

                            <td>{{ form.remise|add_class:"form-control remise-input" }}</td>
                            <td><span class="montant-ligne">0.00</span> F</td>
                            <td><button type="button" class="btn btn-danger btn-sm remove-row">üóëÔ∏è</button></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="button" class="btn btn-outline-primary" id="add-ligne">‚ûï Ajouter un produit</button>
        </div>

        <!-- Total g√©n√©ral -->
        <div class="mb-3 text-end">
            <strong>Total g√©n√©ral : <span id="montant-total-global">0.00</span> F</strong>
        </div>

        <button type="submit" class="btn btn-success w-100">üíæ Enregistrer la vente</button>
        {% if vente_form.errors %}
    <div class="alert alert-danger">
        {{ vente_form.errors }}
    </div>
{% endif %}

{% for form in formset %}
    {% if form.errors %}
        <div class="alert alert-danger">
            {{ form.errors }}
        </div>
    {% endif %}
{% endfor %}

    </form>
</div>

<script>
    const produitsPrix = {
        {% for produit in produits %}
            '{{ produit.id }}': {{ produit.prix_unitaire|floatformat:2 }},
        {% endfor %}
    };

    function recalculerMontants() {
        let totalGlobal = 0;
        document.querySelectorAll('.ligne-form').forEach(function (ligne) {
            const produitSelect = ligne.querySelector('.produit-select');
            const quantiteInput = ligne.querySelector('.quantite-input');
            const remiseInput = ligne.querySelector('.remise-input');
            const montantSpan = ligne.querySelector('.montant-ligne');

            const prix = produitsPrix[produitSelect.value] || 0;
            const quantite = parseFloat(quantiteInput.value) || 0;
            const remise = parseFloat(remiseInput.value) || 0;

            let total = (prix * quantite) - remise;
            if (total < 0) total = 0;

            montantSpan.textContent = total.toFixed(2);
            totalGlobal += total;
        });

        document.getElementById('montant-total-global').textContent = totalGlobal.toFixed(2);
    }

    document.addEventListener('input', recalculerMontants);
    document.addEventListener('change', recalculerMontants);

  document.getElementById('add-ligne').addEventListener('click', function () {
    const formCountInput = document.querySelector('#id_form-TOTAL_FORMS');
    const formCount = parseInt(formCountInput.value);
    const tableBody = document.getElementById('formset-body');

    const lastRow = tableBody.querySelector('.ligne-form:last-child');
    const newRow = lastRow.cloneNode(true);

    newRow.querySelectorAll('input, select').forEach(function (input) {
        const name = input.getAttribute('name').replace(`form-${formCount - 1}`, `form-${formCount}`);
        const id = input.getAttribute('id').replace(`form-${formCount - 1}`, `form-${formCount}`);
        input.setAttribute('name', name);
        input.setAttribute('id', id);
        if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else {
            input.value = '';
        }
    });

    newRow.querySelector('.montant-ligne').textContent = '0.00';
    tableBody.appendChild(newRow);

    // üîΩ Mets √† jour le TOTAL_FORMS ici
    formCountInput.value = formCount + 1;
});


    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-row')) {
            const lignes = document.querySelectorAll('.ligne-form');
            if (lignes.length > 1) {
                e.target.closest('tr').remove();
                recalculerMontants();
                document.querySelector('#id_form-TOTAL_FORMS').value = lignes.length - 1;
            }
        }
    });

    window.onload = recalculerMontants;
</script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        $('#id_client').select2({ width: '100%' });
    });
</script>
{% endblock %}
